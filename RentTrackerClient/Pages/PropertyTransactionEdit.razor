@page "/properties/{PropertyId}/transactions/new"
@page "/properties/{PropertyId}/transactions/edit/{Id}"
@inject PropertyTransactionService TransactionService
@inject PaymentMethodService PaymentMethodService
@inject TransactionCategoryService CategoryService
@inject NavigationManager NavigationManager
@inject ILogger<PropertyTransactionEdit> Logger
@inject IAuthenticationService AuthService

<PageTitle>Transaction Details - Rent Tracker</PageTitle>

<div class="modal fade show" style="display: block;" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(string.IsNullOrEmpty(Id) ? "Add Transaction" : "Edit Transaction")
                </h5>
                <button type="button" class="btn-close" @onclick="NavigateBack"></button>
            </div>
            @if (isLoading)
            {
                <div class="modal-body">
                    <div class="loading-container">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="modal-body">
                    <div class="alert alert-danger">@errorMessage</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-primary" @onclick="NavigateBack">
                        <i class="bi bi-arrow-left"></i>
                        <span class="ms-1">Back to Transactions</span>
                    </button>
                </div>
            }
            else if (transaction != null)
            {
                <EditForm Model="@transaction" OnValidSubmit="HandleValidSubmit">
                    <div class="modal-body">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="transactionType" class="form-label">Transaction Type</label>
                                <select id="transactionType" class="form-select" value="@transaction.TransactionType" @onchange="OnTransactionTypeChanged" disabled="@(!string.IsNullOrEmpty(Id))">
                                    <option value="@TransactionType.Income">Income</option>
                                    <option value="@TransactionType.Expense">Expense</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="amount" class="form-label">Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <InputNumber id="amount" class="form-control" @bind-Value="displayAmount" />
                                </div>
                                <ValidationMessage For="@(() => transaction.Amount)" />
                                @if (transaction.TransactionType == TransactionType.Expense)
                                {
                                    <small class="text-muted">Enter amount as positive value</small>
                                }
                            </div>
                            <div class="col-md-6">
                                <label for="transactionDate" class="form-label">Transaction Date</label>
                                <InputDate id="transactionDate" class="form-control" @bind-Value="transaction.TransactionDate" />
                                <ValidationMessage For="@(() => transaction.TransactionDate)" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="notes" class="form-label">Notes</label>
                                <InputTextArea id="notes" class="form-control" @bind-Value="transaction.Notes" rows="2" />
                                <ValidationMessage For="@(() => transaction.Notes)" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="reference" class="form-label">Reference</label>
                                <InputText id="reference" class="form-control" @bind-Value="transaction.Reference" />
                                <ValidationMessage For="@(() => transaction.Reference)" />
                            </div>
                            <div class="col-md-6">
                                <label for="categoryId" class="form-label">Category</label>
                                <InputSelect id="categoryId" class="form-select" @bind-Value="transaction.CategoryId">
                                    @foreach (var category in categories)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => transaction.CategoryId)" />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="paymentMethod" class="form-label">Payment Method</label>
                                <InputSelect id="paymentMethod" class="form-select" @bind-Value="transaction.PaymentMethodId">
                                    @foreach (var method in paymentMethods)
                                    {
                                        <option value="@method.Id">@method.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => transaction.PaymentMethodId)" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary" @onclick="NavigateBack">
                            <i class="bi bi-x-lg"></i>
                            <span class="ms-1">Cancel</span>
                        </button>
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="bi bi-check-lg"></i>
                            <span class="ms-1">Save</span>
                        </button>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

<div class="modal-backdrop fade show"></div>

@code {
    [Parameter]
    public string PropertyId { get; set; } = string.Empty;

    [Parameter]
    public string? Id { get; set; }

    private PropertyTransaction? transaction;
    private decimal displayAmount
    {
        get => transaction != null ? Math.Abs(transaction.Amount) : 0;
        set
        {
            if (transaction != null)
            {
                transaction.Amount = value;
            }
        }
    }
    private bool isLoading = true;
    private string? errorMessage;
    private List<PaymentMethod> paymentMethods = new();
    private List<PropertyTransactionCategory> categories = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            Console.WriteLine("Initializing PropertyTransactionEdit component...");
            Console.WriteLine($"PropertyId: {PropertyId}");
            Console.WriteLine($"Transaction Id: {Id ?? "new"}");

            // Load payment methods
            Console.WriteLine("Loading payment methods...");
            paymentMethods = (await PaymentMethodService.GetPaymentMethodsAsync()).ToList();
            Console.WriteLine($"Loaded {paymentMethods.Count} payment methods");

            if (!string.IsNullOrEmpty(Id))
            {
                // Edit mode
                transaction = await TransactionService.GetTransactionByIdAsync(PropertyId, Id);
                if (transaction == null)
                {
                    errorMessage = $"Transaction with ID {Id} not found.";
                    return;
                }
                
                // Load categories specific to this transaction type
                var loadedCategories = await CategoryService.GetAllCategoriesAsync(transaction.TransactionType);
                if (loadedCategories == null || !loadedCategories.Any())
                {
                    errorMessage = $"No categories available for {transaction.TransactionType}. Please create a category first.";
                    return;
                }
                categories = loadedCategories.ToList();
            }
            else
            {
                // New transaction mode
                Console.WriteLine($"Creating new transaction for PropertyId: {PropertyId}");
                
                var tenantId = await AuthService.GetCurrentTenantIdAsync();
                if (string.IsNullOrEmpty(tenantId))
                {
                    errorMessage = "Failed to get tenant ID. Please try again.";
                    return;
                }

                // Create new transaction with default values
                var now = DateTime.UtcNow;
                transaction = new PropertyTransaction
                {
                    RentalPropertyId = PropertyId,
                    TransactionType = TransactionType.Income, // Default to Income
                    TransactionDate = now,
                    TenantId = tenantId,
                    CreatedAt = now,
                    UpdatedAt = now,
                    Version = 0,
                    AttachmentIds = new List<string>()
                };

                // Load categories for initial transaction type
                var loadedCategories = await CategoryService.GetAllCategoriesAsync(transaction.TransactionType);
                if (loadedCategories == null || !loadedCategories.Any())
                {
                    errorMessage = $"No categories available for {transaction.TransactionType}. Please create a category first.";
                    return;
                }
                categories = loadedCategories.ToList();

                // Set default category and payment method
                transaction.CategoryId = categories.First().Id;
                if (paymentMethods.Any())
                {
                    transaction.PaymentMethodId = paymentMethods.First().Id;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading transaction: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnTransactionTypeChanged(ChangeEventArgs e)
    {
        try
        {
            if (transaction == null || e.Value == null) return;

            if (Enum.TryParse<TransactionType>(e.Value.ToString(), out var newType))
            {
                errorMessage = null;
                
                // Update transaction type
                transaction.TransactionType = newType;
                Console.WriteLine($"Transaction type changed to: {newType}");

                // Clear categories and trigger UI update
                categories = new List<PropertyTransactionCategory>();
                await InvokeAsync(StateHasChanged);

                // Load new categories
                Console.WriteLine($"Loading categories for {newType}...");
                var loadedCategories = await CategoryService.GetAllCategoriesAsync(newType);
                
                if (loadedCategories != null && loadedCategories.Any())
                {
                    categories = loadedCategories.ToList();
                    transaction.CategoryId = categories.First().Id;
                    Console.WriteLine($"Set category to: {categories.First().Name}");
                }
                else
                {
                    errorMessage = $"No categories available for {newType}. Please create a category first.";
                    Console.WriteLine(errorMessage);
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading categories: {ex.Message}";
            Console.WriteLine($"Error in OnTransactionTypeChanged: {ex}");
        }

        // Always ensure UI is updated
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleValidSubmit()
    {
        if (transaction == null)
            return;

        try
        {
            errorMessage = null;
            Console.WriteLine("Starting transaction submission...");

            // Keep amount positive in storage, negative values handled in UI
            transaction.Amount = Math.Abs(transaction.Amount);
            
            var now = DateTime.UtcNow;
            transaction.TransactionDate = DateTime.SpecifyKind(transaction.TransactionDate, DateTimeKind.Utc);
            transaction.UpdatedAt = now;

            // Get tenant ID
            var tenantId = await AuthService.GetCurrentTenantIdAsync();
            if (string.IsNullOrEmpty(tenantId))
            {
                errorMessage = "Failed to get tenant ID. Please try again.";
                return;
            }
            transaction.TenantId = tenantId;

            if (!string.IsNullOrEmpty(Id))
            {
                // Update existing transaction
                var existingTransaction = await TransactionService.GetTransactionByIdAsync(PropertyId, Id);
                if (existingTransaction == null)
                {
                    errorMessage = "Could not find transaction to update.";
                    return;
                }

                transaction.CreatedAt = existingTransaction.CreatedAt;
                transaction.Version = existingTransaction.Version + 1;
                transaction.AttachmentIds = existingTransaction.AttachmentIds;

                var result = await TransactionService.UpdateTransactionAsync(PropertyId, Id, transaction);
                if (result)
                {
                    NavigateBack();
                }
                else
                {
                    errorMessage = "Failed to update transaction on the server";
                }
            }
            else
            {
                // Create new transaction
                if (string.IsNullOrEmpty(transaction.CategoryId))
                {
                    errorMessage = "Category is required.";
                    return;
                }

                // Validate category exists
                try
                {
                    var serverCategory = await CategoryService.GetCategoryByIdAsync(transaction.CategoryId);
                    if (serverCategory == null)
                    {
                        errorMessage = "Selected category no longer exists. Please select a different category.";
                        var updatedCategories = await CategoryService.GetAllCategoriesAsync(transaction.TransactionType);
                        if (updatedCategories != null)
                        {
                            categories = updatedCategories.ToList();
                        }
                        return;
                    }
                }
                catch (Exception ex)
                {
                    errorMessage = "Failed to validate category. Please try again.";
                    Console.WriteLine($"Error validating category: {ex.Message}");
                    return;
                }

                transaction.CreatedAt = now;
                transaction.Version = 0;
                
                var createdTransaction = await TransactionService.CreateTransactionAsync(PropertyId, transaction);
                if (createdTransaction != null)
                {
                    NavigateBack();
                }
                else
                {
                    errorMessage = "Failed to create transaction. Please try again.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving transaction: {ex.Message}";
            Console.WriteLine($"Exception details: {ex}");
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"/properties/{PropertyId}/transactions");
    }
}